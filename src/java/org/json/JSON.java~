/*
 * JSON.java
 * Copyright 2008 Michael Gottesman
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *  
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package org.json;

import java.io.IOException;
import java.util.Arrays;
import java.lang.reflect.Field;
import java.util.HashSet;

// Following the model of Cloneable. This just means that you want this object to be able to be serialized with toJSON

public class JSON {

  protected static class NoEscapesStringer extends JSONStringer {

    public JSONWriter value(Object o) throws JSONException {
      return this.append(o.toString());
    }

    /**
     * Append a key. The key will be associated with the next value. In an
     * object, every value must be preceded by a key.
     * @param s A key string.
     * @return this
     * @throws JSONException If the key is out of place. For example, keys
     *  do not belong in arrays or if the key is null.
     */
    public JSONWriter key(String s) throws JSONException {
      if (s == null) {
        throw new JSONException("Null key.");
      }
      if (this.mode == 'k') {
        try {
          if (this.comma) {
            this.writer.write(',');
          }
          this.writer.write('"' + s + '"');
          this.writer.write(':');
          this.comma = false;
          this.mode = 'o';
          return this;
        } catch (IOException e) {
          throw new JSONException(e);
        }
      }
      throw new JSONException("Misplaced key.");
    }
  }
  private static Class[] _primitives = {Object.class, Boolean.class, Integer.class, Float.class, Double.class, Long.class};
  protected static HashSet PRIMITIVES = new HashSet(Arrays.asList(_primitives));

  protected static String toJSON(Object o, HashSet alreadyVisited) throws JSONException, IllegalAccessException {

    if(o == null) {
      return "null";
    }
    
    alreadyVisited.add(o);
    Class c = o.getClass();

    JSONStringer s = new NoEscapesStringer();

    if ((JSONable.class).isAssignableFrom(c)) {
      s.object();
      Field[] fields = c.getFields();
      for (int i = 0; i < fields.length; i++) {

        Object fieldValue = fields[i].get(o);

        if (!alreadyVisited.contains(fieldValue)) {
          s.key(fields[i].getName());
          s.value(JSON.toJSON(fieldValue, alreadyVisited));
        }
      }
      s.endObject();
    } else if ((Object[].class).isAssignableFrom(c)) {
      
      Object[] array = (Object[]) o;
      Object _o;
      Class _c;
      s.array();
      for (int j = 0; j < array.length; j++) {
        s.value(JSON.toJSON(array[j], alreadyVisited));
      }
      s.endArray();
    } else {
    // Check this part
      if (c.isPrimitive() || PRIMITIVES.contains(c)||c == JSONObject.class||c==JSONArray.class) {
        return o.toString();
      }
      return '"' + escape(o.toString()) + '"';
    }
    return s.toString();
  }

  public static String toJSON(Object o) throws JSONException, IllegalAccessException {
    HashSet alreadyVisited = new HashSet();
    return escape(JSON.toJSON(o, alreadyVisited));
  }

  protected static String escape(String string) {
    if (string == null || string.length() == 0) {
      return "";
    }

    char b;
    char c = 0;
    int i;
    int len = string.length();
    StringBuffer sb = new StringBuffer(len);
    String t;
    
    for (i = 0; i < len; i += 1) {
      b = c;
      c = string.charAt(i);
      switch (c) {
        case '\\':
        case '"':
          sb.append('\\');
          sb.append(c);
          break;
        case '/':
          if (b == '<') {
            sb.append('\\');
          }
          sb.append(c);
          break;
        case '\b':
          sb.append("\\b");
          break;
        case '\t':
          sb.append("\\t");
          break;
        case '\n':
          sb.append("\\n");
          break;
        case '\f':
          sb.append("\\f");
          break;
        case '\r':
          sb.append("\\r");
          break;
        default:
          if (c < ' ' || (c >= '\u0080' && c < '\u00a0') ||
              (c >= '\u2000' && c < '\u2100')) {
            t = "000" + Integer.toHexString(c);
            sb.append("\\u" + t.substring(t.length() - 4));
          } else {
            sb.append(c);
          }
      }
    }
    return sb.toString();
  }

//  public static class ID implements JSONable {
//
//    public String firstName;
//    public String lastName;
//    public String address;
//    public Factor[] factors;
//    public Credentials[] cred;
//
//    public ID() {
//      firstName = "Michael";
//      lastName = "Gottesman";
//      address = "4801 Evergreen St.";
//      factors = new Factor[]{new Factor(), new Factor(), new Factor()};
//      cred = new Credentials[]{new Credentials(), new Credentials(), new Credentials(), new Credentials()};
//    }
//  }
//
//  public static class Factor implements JSONable {
//
//    public int arand;
//    public String[] brand;
//    public Credentials[] cred;
//
//    public Factor() {
//      arand = 12309340;
//      brand = new String[3];
//      brand[0] = "{ \"test1\" : \"value\" }";
//      brand[1] = "SYN";
//      brand[2] = "ACKSYN";
//      cred = new Credentials[3];
//      cred[0] = new Credentials();
//      cred[1] = new Credentials();
//      cred[2] = new Credentials();
//    }
//  }
//
//  public static class Credentials implements JSONable {
//
//    public Double a;
//    public Long[] b;
//
//    public Credentials() {
//      b = new Long[2];
//      b[0] = new Long(1658723985);
//      b[1] = new Long(1230198236);
//      a = 1231235.2312;
//    }
//  }
//
//  public static void main(String args[]) {
//    ID fs = new ID();
//    try {
//    String s = JSON.toJSON(fs);
//    JSONObject o = new JSONObject(new JSONTokener(s));
//      System.out.println(o.toString());
//    } catch (Exception e) {
//      System.out.println("Exception occured: " + e.toString());
//    }
//  }
}

